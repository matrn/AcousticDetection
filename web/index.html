<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
	<style>
		html,
		body {
			width: 100%;
			height: 100%;
			margin: 0;
		}
	</style>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
</head>

<body class="p-2">
	<h2 class="text-center border border-dark rounded mb-2 p-2">Acoustic Detection</h2>
	<div class="card mb-3">
		<div class="card-header p-2">
			<span class="float-start border border-dark rounded p-2">
				WS:&nbsp;
				<span id="status-dot">⬤</span>
				<span id="status-text">WS not loaded</span>
			</span>

			<span class="float-start border border-dark ms-2 rounded p-2">
				ping:&nbsp;
				<span id="ping">-</span>
			</span>

			<span class="float-end border border-dark rounded p-2">
				Angle:
				<span id="angle">
					-
				</span>
			</span>
		</div>

		<div class="card-body">
			<div id="chart"></div>
		</div>
	</div>
	
	<div class="card mb-3">
		<div class="card-header">
			Logs			
		</div>
		<div class="card-body overflow-auto" id="log" style="height: 10rem">	 
		</div>
	</div>
	


	<script>
		GREEN = '#28a745';
		RED = '#dc3545';
		YELLOW = '#ffc107';
		BLACK = '#000';

		function log(d) {
			d = new Date().toLocaleTimeString() + ": " + d;
			console.log(d);
			var elm = document.getElementById("log");
			elm.innerHTML = elm.innerHTML + d + "<br>";
			elm.scrollTo(0, elm.scrollHeight);
		}



		function set_status(color, text) {
			status_dot = document.getElementById('status-dot');
			status_text = document.getElementById('status-text');

			status_dot.style.color = color;
			status_text.innerHTML = text;
		}

		class WS {
			constructor(host=window.location.host) {
				this.protocol = 'ws://';
				if (location.protocol == 'https:') this.protocol = 'wss://';
				this.host = host;
				this.url = this.protocol + this.host + '/ws';
			}

			connect() {
				log("Trying to connect to " + this.url);
				this.socket = new WebSocket(this.url);

				this.socket.onmessage = function (e) {
					console.log(e.data);
					let angle = parseInt(e.data);
					if(angle < 0 || angle > 180 || isNaN(angle)) log("ERROR: ANGLE out of range (0-180°) " + angle);
					else show_angle(angle-90);
				};

				this.socket.onopen = function (e) {
					log("WS: open now.");
					set_status(GREEN, 'WS active!');
				};

				this.socket.onclose = function (e) {
					var that = this;
					log('WS: socket closed unexpectedly');
					set_status(RED, 'WS closed, reconnecting');

					setTimeout(function () {
						that.connect();
					}, 1000);
				}.bind(this);

				this.socket.onerror = function (event) {
					log("WS error observed: " + event.type);
					console.log(event);
					set_status(RED, 'WS error: ' + event.type);
				};
			}
		}
	</script>

	<script>
		if (!window.WebSocket) {
			log("!WS not supported!");
			alert("WS are not supported by your browser");
		}
		else {
			ws = new WS("192.168.0.115");
			ws.connect();
			set_status(YELLOW, 'WS: Trying to connect');
		}
	</script>

	<script>
		if (!!window.EventSource) {
			let host = window.location.host;
			host = "http://192.168.0.115";
			console.log(host);
			const sse = new EventSource(host + '/events');

			sse.addEventListener('open', function(e) {
				console.log("Events Connected");
			}, false);

			sse.addEventListener('error', function(e) {
				if (e.target.readyState != EventSource.OPEN) {
					console.log("Events Disconnected");
				}
			}, false);

			sse.addEventListener('message', function(e) {
				console.log("message", e.data);
			}, false);

			sse.addEventListener('angle', function(e) {
				console.log("ANGLE", e.data);
			}, false);
			}
	</script>

	<script>
		const TIME_TO_HIDE_VALUE = 2000;
		const BARPOLAR_WIDTH = 10;

		function create_data(angle) {
			return {
				// docs: https://plotly.com/javascript/reference/barpolar/#barpolar
				type: "barpolar",
				//mode: "lines",
				r: [0, 1],
				theta: [0, angle],//-10, angle+10],
				width: BARPOLAR_WIDTH,
				fill: "toself",
				//fillcolor: color,
				opacity: 0.7,
				// line: {
				// 	color: 'black'
				// }
			}
		}
		let data = [
			{type: "barpolar"}   // to keep chart in polar type, without data and this line chart will be broken
		]

		margin = 20;
		let layout = {
			margin: {
				l: margin,
				r: margin,
				b: margin,
				t: margin,
				pad: 10
			},
			polar: {
				// docs: https://plotly.com/javascript/reference/layout/polar/
				radialaxis: {
					visible: false,
				},
				angularaxis: {
					rotation: -90,
					dtick: 10,
					//direction: "counterclockwise"
				},
				sector: [-180, 0],
			},

			showlegend: false

		};

		Plotly.newPlot('chart', data, layout, { staticPlot: true, responsive: true });

		function getRndInteger(min, max) {
			return Math.floor(Math.random() * (max - min)) + min;
		}


		let slots = {};

		function export_and_redraw(){
			new_data = [{type: "barpolar"}];      // type: "barpolar" is there to keep chart in polar type, without data and this line chart will be broken
			
			for(let key of Object.keys(slots)) new_data.push(create_data(key));
			//console.log(new_data);
			data.length = 0;
			data.push.apply(data, new_data);
			console.log(data);
			Plotly.redraw('chart');
		}
		
		let angle_elm = document.getElementById("angle");
		function show_angle(angle){
			if(angle < 0 || angle > 180 || isNaN(angle)) return;
			
			angle_elm.innerHTML = angle + "°";
			setTimeout(()=>{
				angle_elm.innerHTML = "-";
			}, TIME_TO_HIDE_VALUE);
			
			if(slots.hasOwnProperty(angle)){
				clearTimeout(slots[angle].timer);				
			}
			slots[angle] = {'timer': setTimeout(()=>{
				delete slots[angle];
				export_and_redraw();
			}, TIME_TO_HIDE_VALUE)};
			export_and_redraw();
		}
		// setInterval(()=>{
		// 	show_angle(getRndInteger(-90, 90));
		// }, 500);

		show_angle(0);
	</script>
</body>

</html>